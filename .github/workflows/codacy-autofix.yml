name: Codacy Auto-Fix

on:
  workflow_dispatch:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

permissions:
  contents: write
  pull-requests: write

jobs:
  codacy-autofix:
    name: Create Auto-Fix PR
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: '3.11'
        if: hashFiles('**/*.py') != ''

      - name: Set up Rust
        uses: actions-rs/toolchain@16499b5e05bf2e26879000db0c1d13f7e13fa3af # v1
        with:
          toolchain: stable
          components: rustfmt, clippy
        if: hashFiles('**/Cargo.toml') != ''

      - name: Install auto-fix tools
        run: |
          # Python formatters
          if [ -f "requirements.txt" ] || [ -f "*.py" ]; then
            pip install black isort autopep8 pylint
          fi

      - name: Run Codacy Analysis
        id: codacy
        uses: codacy/codacy-analysis-cli-action@30783d03e758713bb5ed7b79292cfb14b9dd9a4a # master
        with:
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
          verbose: true
          output: codacy-results.json
          format: json
          max-allowed-issues: 2147483647
        continue-on-error: true

      - name: Apply Python auto-fixes
        if: hashFiles('**/*.py') != ''
        run: |
          echo "Applying Python auto-fixes..."

          # Format with black
          find . -name "*.py" -not -path "*/venv/*" -not -path "*/.venv/*" | xargs black --line-length 100 || true

          # Sort imports with isort
          find . -name "*.py" -not -path "*/venv/*" -not -path "*/.venv/*" | xargs isort || true

          # Fix PEP8 issues
          find . -name "*.py" -not -path "*/venv/*" -not -path "*/.venv/*" | xargs autopep8 --in-place --aggressive --aggressive || true
        continue-on-error: true

      - name: Apply Rust auto-fixes
        if: hashFiles('**/Cargo.toml') != ''
        run: |
          echo "Applying Rust auto-fixes..."

          # Format with rustfmt
          cargo fmt --all || true

          # Apply clippy fixes (automatic fixes only)
          cargo clippy --fix --allow-dirty --allow-staged || true
        continue-on-error: true

      - name: Check for changes
        id: changes
        run: |
          git config --global user.name 'Codacy Auto-Fix Bot'
          git config --global user.email 'bot@codacy.com'

          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected!"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes to commit"
          fi

      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@c5a7806660adbe173f04e3e038b0ccdcd758773c # v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'fix: Apply Codacy auto-fixes'
          committer: Codacy Auto-Fix Bot <bot@codacy.com>
          author: Codacy Auto-Fix Bot <bot@codacy.com>
          branch: codacy-auto-fix-${{ github.run_number }}
          delete-branch: true
          title: '[Codacy] Auto-fix code quality issues'
          body: |
            ## Codacy Auto-Fix

            This PR contains automatic fixes for code quality issues detected by Codacy.

            ### Changes Applied:
            - ✅ Code formatting (Black, rustfmt)
            - ✅ Import sorting (isort)
            - ✅ PEP8 compliance (autopep8)
            - ✅ Clippy suggestions (Rust)

            ### Review Checklist:
            - [ ] All tests pass
            - [ ] No functional changes introduced
            - [ ] Code style improvements look correct

            **Auto-generated by Codacy Guardrails**
          labels: |
            codacy
            auto-fix
            code-quality
          reviewers: tom14cat14

      - name: Comment on PR
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          echo "✅ Auto-fix PR created successfully!"
          echo "Review the changes and merge if everything looks good."
